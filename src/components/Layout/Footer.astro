---
import SocialLinksBar from "../SocialLinksBar.astro";
import { getLanguageFromURL, loadSharedContent } from "../../utils/i18n";

const currentLang = getLanguageFromURL(Astro.url.pathname);
const footerData = await loadSharedContent("footer", currentLang);

const year = new Date().getFullYear();
const { footer } = footerData;
const copyrightText = footer.copyright.replace("{year}", year.toString());

interface Link {
  label: string;
  href: string;
  external?: boolean;
}

interface Section {
  title: string;
  links: Link[];
}

interface Column {
  title: string;
  links: Link[];
  sections?: Section[];
}

// Helper function to add language prefix to internal links
const prefixLanguage = (href: string) => {
  // Skip external links (http/https)
  if (href.startsWith('http://') || href.startsWith('https://')) {
    return href;
  }
  // For English, keep the original href
  if (currentLang === 'en') {
    return href;
  }
  // For other languages, prefix with language code
  if (href === '/') {
    return `/${currentLang}/`;
  }
  if (href.startsWith('/#')) {
    return `/${currentLang}${href}`;
  }
  if (href.startsWith('/')) {
    return `/${currentLang}${href}`;
  }
  return href;
};

// Process all columns, links and sections with language prefix
const localizedColumns = footer.columns.map((column: Column) => ({
  ...column,
  links: column.links.map((link: Link) => ({ ...link, href: prefixLanguage(link.href) })),
  sections: column.sections?.map((section: Section) => ({
    ...section,
    links: section.links.map((link: Link) => ({ ...link, href: prefixLanguage(link.href) }))
  }))
}));
---

<footer
  class="w-full bottom-0 bg-[var(--color-brand-anthracite)] border-t border-[var(--color-neutral-700)]"
>
  <div class="mx-auto max-w-6xl px-[var(--spacing-l)] py-12">
    <!-- 4 Column Layout -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-8 mb-12">
      {
        localizedColumns.map((column: Column) => (
          <div class="flex flex-col gap-4">
            <h3
              style="color: var(--color-white);"
              class="text-[var(--font-size-base)] font-semibold"
            >
              {column.title}
            </h3>
            <nav class="flex flex-col gap-3">
              {column.links.map((link: Link) => (
                <a
                  href={link.href}
                  {...(link.external
                    ? { target: "_blank", rel: "noopener noreferrer" }
                    : {})}
                  style="color: var(--color-white);"
                  class="text-[var(--font-size-sm)] transition-opacity hover:opacity-70"
                >
                  {link.label}
                </a>
              ))}
            </nav>

            {column.sections?.map((section: Section) => (
              <>
                <h3
                  style="color: var(--color-white);"
                  class="text-[var(--font-size-base)] font-semibold mt-4"
                >
                  {section.title}
                </h3>
                <nav class="flex flex-col gap-3">
                  {section.links.map((link: Link) => (
                    <a
                      href={link.href}
                      {...(link.external
                        ? { target: "_blank", rel: "noopener noreferrer" }
                        : {})}
                      style="color: var(--color-white);"
                      class="text-[var(--font-size-sm)] transition-opacity hover:opacity-70"
                    >
                      {link.label}
                    </a>
                  ))}
                </nav>
              </>
            ))}
          </div>
        ))
      }
    </div>

    <!-- Social icons bar and copyright -->
    <div
      class="flex flex-col items-center gap-6 pt-8 border-t border-[var(--color-neutral-700)]"
    >
      <SocialLinksBar theme={"light"} />
      <p
        style="color: var(--color-neutral-400);"
        class="text-[var(--font-size-xs)]"
      >
        {copyrightText}
      </p>
    </div>
  </div>
</footer>
