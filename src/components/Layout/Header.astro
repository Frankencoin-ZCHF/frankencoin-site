---
import Button from "../Button/Button.astro";
import NavLink from "../Button/NavLink.astro";
import MobileMenu from "./MobileMenu.astro";
import LanguageSwitcher from "../LanguageSwitcher/LanguageSwitcher.astro";
import { getLanguageFromURL, loadSharedContent } from "../../utils/i18n";

const currentLang = getLanguageFromURL(Astro.url.pathname);
const nav = await loadSharedContent("nav", currentLang);
const { brand, links, cta } = nav;

// Helper function to add language prefix to internal links
const prefixLanguage = (href: string) => {
  // Skip external links (http/https)
  if (href.startsWith('http://') || href.startsWith('https://')) {
    return href;
  }
  // For English, keep the original href
  if (currentLang === 'en') {
    return href;
  }
  // For other languages, prefix with language code
  // Handle both "/" and "/#section" formats
  if (href === '/') {
    return `/${currentLang}/`;
  }
  if (href.startsWith('/#')) {
    return `/${currentLang}${href}`;
  }
  if (href.startsWith('/')) {
    return `/${currentLang}${href}`;
  }
  return href;
};

// Process all links with language prefix
const localizedBrand = { ...brand, href: prefixLanguage(brand.href) };
const localizedLinks = links.map(link => ({ ...link, href: prefixLanguage(link.href) }));
---

<header
  class="fixed w-full top-0 z-40 bg-[var(--color-white)] border-b border-[var(--color-neutral-200)] px-5 py-2.5"
>
  <div class="w-full flex items-center justify-between h-11">
    <!-- Left: Brand -->
    <div class="nav-left">
      <a
        href={localizedBrand.href}
        aria-current="page"
        class="inline-flex items-center gap-[var(--spacing-s)]"
      >
        <img
          src="/images/Frankencoin-Logo-Compressify.io.webp"
          alt={`${localizedBrand.name}'s logo`}
          class="h-8 w-auto"
          loading="lazy"
        />
        <span class="sr-only">{localizedBrand.name}</span>
      </a>
    </div>

    <!-- Center: Nav (desktop) -->
    <nav
      role="navigation"
      aria-label="Main"
      class="hidden md:flex items-center gap-[var(--spacing-l)]"
    >
      {localizedLinks.map((l) => <NavLink href={l.href}>{l.label}</NavLink>)}
    </nav>

    <!-- Right: Language Switcher + CTA + Mobile Menu -->
    <div class="flex items-center gap-[var(--spacing-l)]">
      <!-- Language Switcher (desktop) -->
      <div class="hidden md:block">
        <LanguageSwitcher />
      </div>

      <!-- CTA (desktop only) -->
      <div class="hidden lg:block">
        <Button href={nav.cta.href} variant="primary" rounded="full" size="md">
          {nav.cta.label}
        </Button>
      </div>

      <!-- Mobile menu (details/summary accesible) -->
      <details class="md:hidden relative">
        <summary
          class="list-none inline-flex h-9 w-9 items-center justify-center rounded-[var(--radius-button-6)] text-[var(--color-neutral-650)] hover:cursor-pointer focus-visible:outline focus-visible:outline-2 focus-visible:outline-[var(--color-blue-50)]"
          aria-label="Open menu"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-5 w-5"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
            aria-hidden="true"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="1.5"
              d="M4 7h16M4 12h16M4 17h16"></path>
          </svg>
        </summary>
        <MobileMenu />
      </details>
    </div>
  </div>
</header>
