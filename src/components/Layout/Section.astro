---
/* src/components/layout/Section.astro
   Props:
     - id?: string
     - variant?: "plain" | "accent" (default "plain")
     - width?: "narrow" | "content" | "wide" | "full" (default "content")
     - align?: "left" | "center" (default "left")
     - pad?: "sm" | "md" | "lg" (default "md")
     - layout?: "default" | "split" | "feature" (default "default")
     - contentPosition?: "left" | "right" (default "right")
     - imgUrl?: string (optional background image for the whole section)
   
   Slots:
     - default: Main content
     - aside: Secondary content (for split and feature layouts)
*/
import Container from "./Container.astro";

interface Props {
  id?: string;
  variant?: "plain" | "accent";
  width?: "narrow" | "content" | "medium" |"wide" | "full";
  align?: "left" | "center";
  pad?: "none"| "xxs" | "xs" | "sm" | "md" | "lg";
  layout?: "default" | "split" | "feature";
  eyebrow?: string;
  title?: string;
  subtitle?: string;
  contentPosition?: "left" | "right";
  headerPosition?: "items-center" | "items-start";
  imgUrl?: {
    desktop: string;
    mobile: string;
  };
  /** Optional classes for the absolutely-positioned bottom slot */
  bottomClass?: string;
  /** Optional Tailwind margin classes applied to the root section (e.g., "my-8 mt-12") */
  margin?: string;
  /** How the bottom slot is positioned: absolute (overlays) or static (flows after content). Default: "absolute" */
  bottomPosition?: "absolute" | "static";
  /** Tailwind classes to reserve space at the bottom (e.g., "pb-24") when bottomPosition is "absolute" */
  bottomSpacing?: string;
  /** Additional classes applied directly to the root <section> (escape hatch) */
  className?: string;
}

const {
  id,
  variant = "plain",
  width = "wide",
  align = "left",
  headerPosition = "items-center",
  pad = "md",
  layout = "default",
  eyebrow,
  title,
  subtitle,
  contentPosition = "right",
  imgUrl,
  bottomClass,
  margin = "",
  bottomPosition = "absolute",
  bottomSpacing = "",
  className = "",
} = Astro.props as Props;

const pads = {
  none: "",
  xxs: "py-[calc(var(--spacing-l)*1)] md:py-[calc(var(--spacing-l)*2)]", // mobile: ~20px, desktop: ~40px
  xs: "py-[calc(var(--spacing-l)*2)] md:py-[calc(var(--spacing-l)*4)]", // mobile: ~40px, desktop: ~80px
  sm: "py-[calc(var(--spacing-l)*3)] md:py-[calc(var(--spacing-l)*6)]", // mobile: ~60px, desktop: ~120px
  md: "py-[calc(var(--spacing-l)*4)] md:py-[calc(var(--spacing-l)*8)]", // mobile: ~80px, desktop: ~160px
  lg: "py-[calc(var(--spacing-l)*5)] md:py-[calc(var(--spacing-l)*10)]", // mobile: ~100px, desktop: ~200px
}[pad];

// Optional background image support
const hasBgImage = typeof imgUrl === "object" && imgUrl?.desktop?.length > 0;
// Background color: ensure gray on mobile if there's an image, transparent only on desktop
const bg = hasBgImage
  ? "bg-[var(--color-gray-10)] md:bg-transparent"
  : variant === "accent"
    ? "bg-[var(--color-gray-10)]"
    : "bg-[var(--color-white)]";
const bgImageClasses = hasBgImage ? "md:bg-cover md:bg-center md:bg-no-repeat" : "";
const sectionStyle = hasBgImage ? `--section-bg: url('/${imgUrl?.desktop}')` : undefined;

const textAlign = align === "center" ? "text-center" : "text-left";

// Layout classes
const isContentLeft = contentPosition === "left";
const flexOrder = isContentLeft ? "md:flex-row-reverse" : "md:flex-row";

const mainBasis = isContentLeft ? "md:basis-4/5" : "md:basis-1/5";
const asideBasis = isContentLeft ? "md:basis-1/5" : "md:basis-4/5"; 

const parseMarkdownLinks = (text: string) => {
  return text.replace(
    /\[([^\]]+)\]\(([^)]+)\)/g,
    '<a href="$2" target="_blank" rel="noopener noreferrer" class="text-[var(--color-brand-swiss)] hover:underline">$1</a>'
  );
};
---

<section id={id} data-has-bg={hasBgImage ? 'true' : 'false'} class={`${pads} ${bg} ${bgImageClasses} section-bg relative overflow-unset z-0 ${margin} ${bottomPosition === 'absolute' ? bottomSpacing : ''} ${className}` } style={sectionStyle}>
  <div class="relative z-10">
 {hasBgImage && 
    <img src={`/${imgUrl?.mobile}`} class="md:hidden object-cover w-full h-[300px] " alt="image" />
}

    <Container width={width} id={id}>
    {layout === "default" && (
      <div class={`${textAlign}`}>

        <div class="flex flex-col gap-2 items-center mb-8">
          {eyebrow && <h3 class="ty-subtitle">{eyebrow.toUpperCase()}</h3>}
          {title && <h1 class="ty-large-title ">{title}</h1>}
          {subtitle && <h2 class="ty-body-1" set:html={parseMarkdownLinks(subtitle)}/>}
        </div>
        <slot />
      </div>
    )}

    {layout === "split" && (
      <div class={`flex flex-col ${flexOrder} gap-8 md:gap-12 ${headerPosition}`}>
        <!-- Contenido principal -->
        <div class={`${mainBasis} space-y-6`}>

          {eyebrow && <h3 class="ty-subtitle mb-0">{eyebrow.toUpperCase()}</h3>}
          {title && <h1 class="ty-large-title">{title}</h1>}
          {subtitle && <h2 class="ty-body-1" set:html={parseMarkdownLinks(subtitle)}/>}
          <slot />
        </div>
        
        <div class={`${asideBasis} w-full`}>
          <slot name="aside" />
        </div>
      </div>
    )}

    {layout === "feature" && (
      <div class="space-y-8">
        <!-- Header centrado -->
        <div class="text-center space-y-4">
          {eyebrow && <h3 class="ty-subtitle">{eyebrow.toUpperCase()}</h3>}
          {title && <h1 class="ty-large-title">{title}</h1>}
          {subtitle && <h2 class="ty-body-1" set:html={parseMarkdownLinks(subtitle)}/>}
        </div>
        
        <!-- Contenido con aside -->
        <div class={`flex flex-col ${flexOrder} gap-8 md:gap-12 items-center`}>
          <!-- Contenido principal -->
          <div class={`${mainBasis}`}>
            <slot />
          </div>
          
          <!-- Contenido secundario -->
          <div class={` ${asideBasis}`}>
            <slot name="aside" />
          </div>
        </div>
      </div>
    )}
  
    </Container>
    
  </div>
  {bottomPosition === 'absolute' ? (
    <>
      <div class={`${bottomClass ?? ''} md:hidden absolute inset-x-0 top-[90%] md:px-0 px-4 z-20 w-full`}>
        <slot name="bottom" />
      </div>
      <div class={` hidden md:block absolute inset-x-0 top-[90%] z-20 ${bottomClass ?? ''}`}>
        <slot name="bottom" />
      </div>
    </>
  ) : (
    <div class={`${bottomClass ?? ''}`}>
      <slot name="bottom" />
    </div>
  )}
</section>

<style>
  @media (min-width: 768px) {
    .section-bg[data-has-bg="true"] {
      background-image: var(--section-bg);
    }
  }
</style>
