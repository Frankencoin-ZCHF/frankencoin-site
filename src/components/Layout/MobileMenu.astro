---
import Button from "../Button/Button.astro";
import LanguageSwitcher from "../LanguageSwitcher/LanguageSwitcher.astro";
import { getLanguageFromURL, loadSharedContent, loadContent } from "../../utils/i18n";

const currentLang = getLanguageFromURL(Astro.url.pathname);
const nav = await loadSharedContent("nav", currentLang);
const index = await loadContent("index", currentLang);

// Helper function to add language prefix to internal links
const prefixLanguage = (href: string) => {
  // Skip external links (http/https)
  if (href.startsWith('http://') || href.startsWith('https://')) {
    return href;
  }
  // For English, keep the original href
  if (currentLang === 'en') {
    return href;
  }
  // For other languages, prefix with language code
  // Handle both "/" and "/#section" formats
  if (href === '/') {
    return `/${currentLang}/`;
  }
  if (href.startsWith('/#')) {
    return `/${currentLang}${href}`;
  }
  if (href.startsWith('/')) {
    return `/${currentLang}${href}`;
  }
  return href;
};

// Process all links with language prefix
const localizedLinks = nav.links.map(link => ({ ...link, href: prefixLanguage(link.href) }));
---

<div
  class="fixed left-0 right-0 top-[60px] h-[calc(100vh-60px)] w-full bg-[var(--color-gray-15)] shadow-lg overflow-y-auto animate-slide-down"
  id="mobile-menu"
>
  <nav class="flex flex-col gap-2 px-5 pt-8 pb-6" aria-label="Mobile">
    {
      localizedLinks.map((l) => (
        <a
          href={l.href}
          class="mobile-nav-link ty-body-1-mobile block rounded-lg px-4 py-3 text-[var(--color-brand-deep-blue)] hover:text-[var(--color-brand-swiss)] active:text-[var(--color-brand-swiss)]"
        >
          {l.label}
        </a>
      ))
    }
    <hr class="text-[var(--color-neutral-300)]" />
    <div class="mt-4 flex flex-col gap-4">
      <LanguageSwitcher />
      <Button href={nav.cta.href} variant="primary" rounded="full" size="md" external={true}>
        {index.hero.cta.label}
      </Button>
    </div>
  </nav>
</div>

<script>
  // Close mobile menu when clicking on any nav link
  document.addEventListener('DOMContentLoaded', () => {
    const mobileMenu = document.getElementById('mobile-menu');
    const navLinks = mobileMenu?.querySelectorAll('.mobile-nav-link');

    navLinks?.forEach(link => {
      link.addEventListener('click', () => {
        // Find the parent details element and close it
        const details = mobileMenu?.closest('details');
        if (details) {
          details.removeAttribute('open');
        }
      });
    });
  });
</script>

<style>
  @keyframes slide-down {
    from {
      transform: translateY(-100%);
      opacity: 0;
    }
    to {
      transform: translateY(0);
      opacity: 1;
    }
  }

  .animate-slide-down {
    animation: slide-down 0.3s ease-out forwards;
  }
</style>
