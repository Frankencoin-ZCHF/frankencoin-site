---
import Section from "../components/Layout/Section.astro";
import SectionHeader from "../components/Layout/SectionHeader.astro";
import Base from "../layouts/Base.astro";
import { getLanguageFromURL, loadContent, loadGlobalSharedContent } from "../utils/i18n";

const currentLang = getLanguageFromURL(Astro.url.pathname);
const index = await loadContent("index", currentLang);
const media = await loadGlobalSharedContent("media");
const faq = await loadContent("faq", currentLang);
import FeaturesContainer from "../components/FeaturesContainer/FeaturesContainer.astro";
import TabMenu from "../components/TabsMenu/TabMenu.astro";
import FoundationContainer from "../components/FoundationContainer/FoundationContainer.astro";
import TrustSecurityContainer from "../components/TrustSecurityContainer/TrustSecurityContainer.astro";
import FAQContainer from "../components/FAQContainer/FAQContainer.astro";
import AssetsContainer from "../components/AssetsContainer/AssetsContainer.astro";
import FlexStack from "../components/Layout/FlexStack.astro";
import BadgeContainer from "../components/BadgeContainer/BadgeContainer.astro";
import ExplanationCardsContainer from "../components/ExplanationCardsContainer/ExplanationCardsContainer.astro";
import MediaCarousel from "../components/MediaCarousel/MediaCarousel.astro";
import UseCasesAccordion from "../components/UseCasesAccordion/UseCasesAccordion.astro";

export const prerender = false;

async function getFrankencoinInfo() {
  try {
    let response = await fetch(
      "https://api.frankencoin.com/ecosystem/frankencoin/info"
    );
    if (!response.ok) throw new Error("Failed to fetch quote");
    return response.json();
  } catch (error) {
    console.error("Error fetching data:", error);
    return null;
  }
}

const frankencoinInfo = await getFrankencoinInfo();

type StatMeta = { label?: string; unit?: string; href?: string; value?: string };

function findStat(id: string): StatMeta {
  return ((index.stats ?? []).find((s: any) => s.id === id) || {}) as StatMeta;
}

function formatAmount(n: number) {
  if (typeof n !== "number" || Number.isNaN(n)) return "0";
  return n.toFixed(0).replace(/\d{1,3}(?=(\d{3})+(?!\d))/g, "$&'");
}

const s1 = findStat("totalSupply");
const s2 = findStat("totalValueLocked");
const s4 = findStat("compliance");

const stats: Option[] = frankencoinInfo
  ? [
      {
        label: s1.label ?? "Money circulating",
        value: formatAmount(frankencoinInfo.token?.supply ?? 0),
        unit: s1.unit,
        href: s1.href,
      },
      {
        label: s2.label ?? "Collateral value",
        value: formatAmount(frankencoinInfo.tvl?.chf ?? 0),
        unit: s2.unit,
        href: s2.href,
      },
      {
        label: s4.label ?? "Fully Compliant",
        value: s4.value ?? "Swiss Law & MiCAR",
        href: s4.href ?? "/#trust-security",
      },
    ]
  : [];

Astro.response.headers.set('Cache-Control', 'public, max-age=300, s-maxage=300');
---


---

<Base>
  <Section
    id="main-page-header"
    variant="accent"
    align="center"
    pad="xxs"
    imgUrl={index.hero.image}
  >
    <div class="min-h-screen flex flex-col justify-center gap-24 pt-20 pb-4">
      <SectionHeader
        title={index.hero.title}
        subtitle={index.hero.subtitle}
        margin="none"
        size="display"
        align="left"
        padding="xl"
        cta={{
          label: index.hero.cta.label,
          href: index.hero.cta.href,
          variant: "primary",
        }}
        ctaHideOnLarge={true}
      />

      <div class="flex flex-col items-center gap-8">
        <BadgeContainer options={stats} />

        <div class="flex flex-col sm:flex-row items-center justify-center gap-4 sm:gap-8">
          {index.hero.cta_buttons.map((button) => (
            <a
              href={button.href}
              target="_blank"
              rel="noopener noreferrer"
              class="flex items-center gap-2 text-[var(--color-brand-deep-blue)] ty-body-1 font-semibold hover:text-[var(--color-brand-swiss)] transition-colors"
            >
              <span>{button.label}</span>
              <img src="/images/Arrow.svg" loading="lazy" alt="" class="w-3 h-3" />
            </a>
          ))}
        </div>
      </div>
    </div>
  </Section>

  <Section
    id="what-is"
    eyebrow={index.what_is.eyebrow}
    title={index.what_is.title}
    subtitle={index.what_is.subtitle}
    pad="xs"
    margin="lg:mt-20 mt-32"
  >
    <ExplanationCardsContainer cards={index.what_is.explanation} />
  </Section>

  <Section
    id="core-features"
    eyebrow={index.core_features.eyebrow}
    title={index.core_features.title}
    pad="xs"
    margin="lg:mt-20 mt-60"
  >
    <FeaturesContainer features={index.core_features.features} />
    <div class="mt-12">
      <UseCasesAccordion buttonLabel={index.core_features.more_link.label} />
    </div>
  </Section>
  <Section
    id="how-does-it-work"
    title={index.how_it_works.title}
    subtitle={index.how_it_works.subtitle}
    eyebrow={index.how_it_works.eyebrow}
  >
    <div id="how-does-it-work"></div>
    <div class="flex md:flex-row flex-col gap-40px items-stretch gap-8 mb-16">
      <TabMenu tabs={index.how_it_works.steps} />
    </div>
    <ExplanationCardsContainer cards={index.how_does_it_work.explanation} />
  </Section>
    
    <Section
    id="foundation"
    layout="split"
    title={index.foundation.title}
    subtitle={index.foundation.description}
    contentPosition="left"
    variant="accent"
  >
    <div
      class="flex md:flex-row flex-col gap-10px items-stretch gap-8"
      slot="aside"
    >
      <img src={index.foundation.image} alt={index.foundation.imageAlt} />
    </div>
    <FoundationContainer />
  </Section>




  <Section
    id="trust-security"
    eyebrow={index.trust_security.eyebrow}
    title={index.trust_security.title}
    width="full"
  >
    <TrustSecurityContainer />
  </Section>



  <Section
    id="in-the-media"
    eyebrow={index.in_the_media.eyebrow}
    title={index.in_the_media.title}
    subtitle={index.in_the_media.subtitle}
    variant="accent"
  >
    <MediaCarousel articles={media.articles} videos={media.videos} />
  </Section>

  <Section
    id="faq"
    title={faq.title}
    layout="split"
    headerPosition="items-start"
  >
    <FAQContainer faqs={faq} slot="aside" />
  </Section>
</Base>
