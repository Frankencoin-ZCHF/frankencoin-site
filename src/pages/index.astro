---
import Section from "../components/Layout/Section.astro";
import SectionHeader from "../components/Layout/SectionHeader.astro";
import Base from "../layouts/Base.astro";
import index from "../content/index.json";
import FlexStack from "../components/Layout/FlexStack.astro";
import SocialLinksBar from "../components/SocialLinksBar.astro";
import BadgeContainer from "../components/BadgeContainer/BadgeContainer.astro";
import type { Option } from "../components/BadgeContainer/BadgeContainer.astro";
import FeaturesContainer from "../components/FeaturesContainer/FeaturesContainer.astro";
import ChainContainer from "../components/ChainContainer/ChainContainer.astro";
import TabMenu from "../components/TabsMenu/TabMenu.astro";
import EcosystemContainer from "../components/EcosystemContainer/EcosystemContainer.astro";
import EcosystemPartners from "../components/EcosystemContainer/EcosystemPartners.astro";
import FoundationContainer from "../components/FoundationContainer/FoundationContainer.astro";
import AuditsContainer from "../components/AuditsContainer/AuditsContainer.astro";
import FAQContainer from "../components/FAQContainer/FAQContainer.astro";
import AssetsContainer from "../components/AssetsContainer/AssetsContainer.astro";

async function getFrankencoinInfo() {
  try {
    let response = await fetch(
      "https://api.frankencoin.com/ecosystem/frankencoin/info"
    );
    if (!response.ok) throw new Error("Failed to fetch quote");
    return response.json();
  } catch (error) {
    console.error("Error fetching data:", error);
    return null;
  }
}

const frankencoinInfo = await getFrankencoinInfo();

type StatMeta = { label?: string; unit?: string; href?: string };

function findStat(id: string): StatMeta {
  return ((index.stats ?? []).find((s: any) => s.id === id) || {}) as StatMeta;
}

function formatAmount(n: number) {
  if (typeof n !== "number" || Number.isNaN(n)) return "0.00";
  return n.toFixed(2).replace(/\d{1,3}(?=(\d{3})+(?!\d))/g, "$&'");
}

const s1 = findStat("totalValueLocked");
const s2 = findStat("totalSupply");
const s3 = findStat("fpsMarketCap");

const stats: Option[] = frankencoinInfo
  ? [
      {
        label: s1.label ?? "Total value locked",
        value: formatAmount(frankencoinInfo.tvl?.chf ?? 0),
        unit: s1.unit,
        href: s1.href,
      },
      {
        label: s2.label ?? "Total supply",
        value: formatAmount(frankencoinInfo.token?.supply ?? 0),
        unit: s2.unit,
        href: s2.href,
      },
      {
        label: s3.label ?? "fps market cap",
        value: formatAmount(frankencoinInfo.fps?.marketCap ?? 0),
        unit: s3.unit,
        href: s3.href,
      },
    ]
  : [];
---

<Base>
  <Section
    variant="accent"
    width="content"
    align="center"
    pad="lg"
    id="main-page-header"
    imgUrl={index.hero.image}
    margin="lg:my-0"
  >
    <FlexStack direction="col" gap="40px" align="start" marginY="150px">
      <SectionHeader
        title={index.hero.title}
        subtitle={index.hero.subtitle}
        maxWidth="lg"
        size="display"
        align="left"
        padding="xxl"
      />

      <SocialLinksBar theme={"dark"} />
    </FlexStack>
  </Section>
  <Section id="stats" pad="sm" align="center">
    <BadgeContainer options={stats} />
  </Section>

  <Section
    id="core-features"
    eyebrow={index.core_features.eyebrow}
    title={index.core_features.title}
  >
    <FeaturesContainer features={index.core_features.features} />
  </Section>

  <Section
    id="tokens"
    title={index.tokens.title}
    subtitle={index.tokens.subtitle}
  >
    <ChainContainer tokens={index.tokens.chains} />
  </Section>
  <Section id="fps" title={index.fps.title} subtitle={index.fps.subtitle}>
    <div class="flex md:flex-row flex-col gap-40px items-stretch gap-8">
      <ChainContainer tokens={[index.fps.chain]} />
    </div>
  </Section>
  <Section
    id="svzchf"
    title={index.svzchf.title}
    subtitle={index.svzchf.subtitle}
  >
    <div class="flex md:flex-row flex-col gap-40px items-stretch gap-8">
      <ChainContainer tokens={[index.svzchf.chain]} />
    </div>
  </Section>
  <Section
    id="system"
    title={index.system.title}
    subtitle={index.system.subtitle}
  >
    <div class="flex md:flex-row flex-col gap-40px items-stretch gap-8">
      <TabMenu tabs={index.system.steps} />
    </div>
    <Section
      id="ecosystem"
      layout="split"
      eyebrow={index.ecosystem.eyebrow}
      title={index.ecosystem.title}
      subtitle={index.ecosystem.description}
      contentPosition="right"
    >
      <EcosystemContainer />
      <EcosystemPartners slot="aside" />
    </Section>

    <Section
      id="foundation"
      layout="split"
      title={index.foundation.title}
      subtitle={index.foundation.description}
      contentPosition="left"
    >
      <div
        class="flex md:flex-row flex-col gap-40px items-stretch gap-8"
        slot="aside"
      >
        <img src={index.foundation.image} alt={index.foundation.imageAlt} />
      </div>
      <FoundationContainer />
    </Section>
    <Section
      id="audits"
      layout="split"
      eyebrow={index.audits.eyebrow}
      title={index.audits.title}
      subtitle={index.audits.subtitle}
    >
      <AuditsContainer slot="aside" />
    </Section>
    <Section
      id="classification"
      layout="split"
      contentPosition="left"
      title={index.classification.title}
      subtitle={index.classification.summary}
    >
      <div
        class="flex md:flex-row flex-col gap-40px items-stretch gap-8"
        slot="aside"
      >
        <img
          src={index.classification.image}
          alt={index.classification.imageAlt}
          loading="lazy"
          width="175"
          height="175"
        />
      </div>
    </Section>
    <Section id="faq" title={index.faq.title}>
      <FAQContainer faqs={index.faq.questions} />
    </Section>
  </Section>
  <Section id="brand-assets" variant="accent" width="content">
    <div
      class="mx-auto max-w-6xl px-[var(--spacing-l)] flex flex-col items-center gap-[var(--spacing-l)]"
    >
      <AssetsContainer assets={index.brand_assets.assets} />
    </div>
  </Section>
</Base>
